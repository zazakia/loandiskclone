generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  STAFF
  COLLECTOR
}

enum InterestType {
  FLAT
  REDUCING
}

enum TermUnit {
  DAYS
  WEEKS
  MONTHS
}

enum RepaymentCycle {
  DAILY
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum LoanStatus {
  PENDING
  APPROVED
  DISBURSED
  COMPLETED
  DEFAULTED
  WRITTEN_OFF
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  MOBILE_MONEY
  ATM
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  INTEREST
  FEE
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String? // Optional if using Clerk exclusively, but good to keep for flexibility
  firstName    String?
  lastName     String?
  role         Role     @default(STAFF)
  permissions  Json? // Granular permissions
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Branch {
  id        String     @id @default(cuid())
  name      String
  address   String?
  holidays  Json?
  users     User[]
  borrowers Borrower[]
  loans     Loan[]
  expenses  Expense[]
}

model Borrower {
  id            String           @id @default(cuid())
  branchId      String
  firstName     String
  lastName      String
  businessName  String?
  uniqueId      String           @unique
  mobile        String
  email         String?
  address       String?
  city          String?
  province      String?
  zipCode       String?
  dob           DateTime?
  gender        String?
  photoUrl      String?
  groupId       String?
  loanOfficerId String?
  customFields  Json?
  branch        Branch           @relation(fields: [branchId], references: [id])
  loans         Loan[]
  savings       SavingsAccount[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model LoanProduct {
  id           String       @id @default(cuid())
  name         String
  minPrincipal Decimal
  maxPrincipal Decimal
  interestRate Decimal
  interestType InterestType
  term         Int
  termUnit     TermUnit
  fees         Json?
  penalties    Json?
  loans        Loan[]
}

model Loan {
  id                 String         @id @default(cuid())
  branchId           String
  borrowerId         String
  productId          String
  principal          Decimal
  interestRate       Decimal
  duration           Int
  repaymentCycle     RepaymentCycle
  status             LoanStatus     @default(PENDING)
  disbursedAt        DateTime?
  firstRepaymentDate DateTime?
  collateral         Json?
  guarantors         Json?
  customFields       Json?
  branch             Branch         @relation(fields: [branchId], references: [id])
  borrower           Borrower       @relation(fields: [borrowerId], references: [id])
  product            LoanProduct    @relation(fields: [productId], references: [id])
  repayments         Repayment[]
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
}

model Repayment {
  id          String        @id @default(cuid())
  loanId      String
  amount      Decimal
  date        DateTime
  method      PaymentMethod
  collectedBy String?
  notes       String?
  loan        Loan          @relation(fields: [loanId], references: [id])
  createdAt   DateTime      @default(now())
}

model SavingsAccount {
  id            String               @id @default(cuid())
  borrowerId    String
  productId     String?
  accountNumber String               @unique
  balance       Decimal              @default(0)
  interestRate  Decimal
  borrower      Borrower             @relation(fields: [borrowerId], references: [id])
  transactions  SavingsTransaction[]
  createdAt     DateTime             @default(now())
}

model SavingsTransaction {
  id        String          @id @default(cuid())
  accountId String
  type      TransactionType
  amount    Decimal
  date      DateTime
  account   SavingsAccount  @relation(fields: [accountId], references: [id])
}

model Expense {
  id           String   @id @default(cuid())
  branchId     String
  categoryId   String?
  amount       Decimal
  date         DateTime
  description  String?
  customFields Json?
  branch       Branch   @relation(fields: [branchId], references: [id])
}

model CollateralType {
  id   String @id @default(cuid())
  name String
}
